# 手动修复微信8.0.9iOS客户端中WASM能力异常指引

## 概述

------

在微信客户端(iOS 8.0.9)中小游戏使用WASM时有概率对部分的WASM库调用发生报错，例如目前Cocos Creator3中使用WASM版本的Ammo物理引擎是将会发生异常。

该问题在微信开发者社区中其他人的提问地址为：https://developers.weixin.qq.com/community/minigame/doc/0002a0271c4d982fa07cdb3795b400

根据官方的说明是指JS胶水层代码在对同一个函数的导出做了次数限制，超过3次函数将没有实际的指针，官方将在后续的客户端版本修复这一问题，但修复前需要进行手动适配，经过本人的实际操作，已成功修复，因此本文将总结出这一问题的修复指引。



## 修复说明

------

下图是官方给出的解决思路

<img src="https://raw.githubusercontent.com/liuxinyumocn/WXWASMFIX/master/img/WX20210812-154119%402x.png" alt="image-20210410210434454" />



简单地说，我们解决过程是：

1. 在模拟器中打印出当前的WASM胶水层代码的句柄列表 **list1**；
2. 再试图导出iOS微信客户端中的WASM胶水层代码的句柄列表 **list2**；
3. 此时统计list2中缺失的（不在list1）中的函数名列表 **list3**；
4. 回到list1中可以看到不同函数名其对应的实际指针ID（函数），将list3的Key健替换成list2中存在且指针相同的导出名，形成替换 **map1**；
5. 根据map1完成对胶水层的更替，至此解决此类问题。

通常来说list的数量很大，我们需要写一个简单的脚本对其进行批量处理，为了方便大家的使用，我写了一个在线的替换工具，需要大家根据指引填入相应的信息，在线工具源代码在本仓库目录 /tool/ 内。**由于修复是根据WASM在iOS真机上的实际表现有关，因此该工具并不能一键完成转换，请参考下方实践完成这一修复工作。**



## 实践修复

------

本文给出Ammo.wasm的手动修复实践案例。

修复前的 Demo 源代码在本仓库目录 /demo/prev/ 内

修复后的 Demo 源代码在本仓库目录 /demo/fixed/ 内





